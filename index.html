<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Election Results Dashboard</title>
    <script src="https://code.highcharts.com/highcharts.js"></script>
    <script src="https://code.highcharts.com/modules/item-series.js"></script>
    
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f0f2f5; display: flex; flex-direction: column; align-items: center; padding: 20px; margin: 0; }
        .container-wrapper { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); width: 95%; max-width: 1000px; margin-top: 20px; }
        .header { text-align: center; margin-bottom: 20px; }
        .controls { text-align: center; margin-bottom: 30px; }
        select { padding: 10px 20px; border-radius: 25px; border: 2px solid #007bff; font-size: 16px; cursor: pointer; background: white; outline: none; }
        #chart-container { height: 600px; width: 100%; }
        #status { font-weight: bold; color: #007bff; margin-bottom: 10px; }
        .majority-badge { text-align: center; margin-top: -30px; font-size: 18px; color: #444; }
    </style>
</head>
<body>

<div class="container-wrapper">
    <div class="header">
        <h1>Political Orientation Dashboard</h1>
        <div id="status">Loading data from Google Sheets...</div>
    </div>

    <div class="controls">
        <label for="electionSelect"><b>Select Legislature:</b> </label>
        <select id="electionSelect" onchange="renderSelection()">
            <option value="">-- Select --</option>
        </select>
    </div>

    <div id="chart-container"></div>
    <div id="majority-info" class="majority-badge"></div>
</div>

<script>
const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSyXtnBVLH8-6135tCS-f9EX3WBxfY8ZVe77zvJx4YIRDv3X7_9xZ68vWsUiWmkldfIL1jCRWkOxpfB/pub?gid=947087391&single=true&output=csv';

let electionData = [];
let chart;

// 1. Fetch data from Google Sheets
async function fetchData() {
    try {
        const response = await fetch(CSV_URL);
        const csvText = await response.text();
        parseCSV(csvText);
        document.getElementById('status').innerText = "Data Loaded Successfully";
        setTimeout(() => document.getElementById('status').style.display = 'none', 3000);
    } catch (error) {
        console.error("Error fetching CSV:", error);
        document.getElementById('status').innerText = "Error loading data. Please check the URL.";
        document.getElementById('status').style.color = "red";
    }
}

// 2. Simple CSV Parser
function parseCSV(text) {
    const lines = text.trim().split('\n');
    const headers = lines[0].split(',');
    
    // Convert CSV rows to JSON objects
    electionData = lines.slice(1).map(line => {
        // This handle cases where party names might contain commas inside quotes
        const values = line.match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g); 
        if (!values) return null;
        
        return {
            country: values[0].replace(/"/g, ''),
            body: values[1].replace(/"/g, ''),
            totalSeats: parseInt(values[2]),
            year: values[3],
            party: values[4].replace(/"/g, ''),
            seats: parseInt(values[5]),
            color: values[7].trim()
        };
    }).filter(item => item !== null);

    populateDropdown();
}

// 3. Setup Dropdown
function populateDropdown() {
    const select = document.getElementById('electionSelect');
    // Get unique "Country - Body" combinations
    const uniqueKeys = [...new Set(electionData.map(d => `${d.country} - ${d.body}`))];
    
    uniqueKeys.forEach(key => {
        let opt = document.createElement('option');
        opt.value = key;
        opt.innerHTML = key;
        select.appendChild(opt);
    });

    // Auto-select the first one
    if (uniqueKeys.length > 0) {
        select.value = uniqueKeys[0];
        renderSelection();
    }
}

// 4. Render the Chart
function renderSelection() {
    const selectedKey = document.getElementById('electionSelect').value;
    const filtered = electionData.filter(d => `${d.country} - ${d.body}` === selectedKey);
    
    if (filtered.length === 0) return;

    const totalSeats = filtered[0].totalSeats;
    const majority = Math.floor(totalSeats / 2) + 1;
    const chartData = filtered.map(d => [d.party, d.seats, d.color]);

    document.getElementById('majority-info').innerHTML = `Total Seats: <b>${totalSeats}</b> | Majority Required: <b>${majority}</b>`;

    if (chart) chart.destroy();

    chart = Highcharts.chart('chart-container', {
        chart: { type: 'item' },
        title: { 
            text: filtered[0].country + ' Election ' + filtered[0].year,
            style: { fontSize: '24px', fontWeight: 'bold' }
        },
        subtitle: { text: filtered[0].body },
        xAxis: {
            plotLines: [{
                value: 0,
                color: '#444',
                dashStyle: 'LongDash',
                width: 3,
                zIndex: 5,
                label: { 
                    text: `Majority: ${majority}`, 
                    verticalAlign: 'top',
                    textAlign: 'center',
                    y: -15,
                    style: { fontWeight: 'bold', fontSize: '14px' }
                }
            }]
        },
        legend: {
            labelFormat: '{name} <span style="opacity: 0.6">({y})</span>'
        },
        series: [{
            name: 'Seats',
            data: chartData,
            center: ['50%', '88%'],
            size: '170%',
            startAngle: -100,
            endAngle: 100,
            dataLabels: { enabled: false }
        }],
        tooltip: {
            headerFormat: '',
            pointFormat: '<b>{point.name}</b>: {point.y} seats'
        },
        credits: { enabled: false }
    });
}

// Initialize on page load
fetchData();
</script>

</body>
</html>