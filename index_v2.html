<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Election Results Dashboard</title>
    <script src="https://code.highcharts.com/highcharts.js"></script>
    <script src="https://code.highcharts.com/modules/item-series.js"></script>
    
    <style>
        * { box-sizing: border-box; }
        
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: #f0f2f5; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            padding: 15px; 
            margin: 0; 
        }
        
        .container-wrapper { 
            background: white; 
            padding: 20px; 
            border-radius: 12px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.1); 
            width: 100%; 
            max-width: 1000px; 
            margin-top: 10px; 
        }
        
        .header { 
            text-align: center; 
            margin-bottom: 20px; 
        }
        
        .header h1 {
            font-size: 28px;
            margin: 0 0 10px 0;
        }
        
        .controls { 
            text-align: center; 
            margin-bottom: 20px; 
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .controls label {
            font-size: 14px;
        }
        
        select { 
            padding: 10px 15px; 
            border-radius: 25px; 
            border: 2px solid #007bff; 
            font-size: 14px; 
            cursor: pointer; 
            background: white; 
            outline: none;
            width: 100%;
            max-width: 400px;
            margin: 0 auto;
        }
        
        #chart-container { 
            height: 500px; 
            width: 100%; 
            min-height: 400px;
        }
        
        #status { 
            font-weight: bold; 
            color: #007bff; 
            margin-bottom: 10px; 
            font-size: 14px;
        }
        
        .majority-badge { 
            text-align: center; 
            margin-top: 10px; 
            font-size: 14px; 
            color: #444;
            padding: 10px;
        }

        /* Media Queries for Small Screens */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            .container-wrapper {
                padding: 15px;
                margin-top: 5px;
            }

            .header h1 {
                font-size: 22px;
                margin-bottom: 5px;
            }

            .controls {
                margin-bottom: 15px;
                gap: 8px;
            }

            .controls label {
                font-size: 13px;
            }

            select {
                font-size: 13px;
                padding: 8px 12px;
            }

            #chart-container {
                height: 400px;
                min-height: 300px;
            }

            .majority-badge {
                font-size: 13px;
                margin-top: 8px;
            }
        }

        @media (max-width: 480px) {
            body {
                padding: 8px;
            }

            .container-wrapper {
                padding: 12px;
                border-radius: 8px;
            }

            .header h1 {
                font-size: 18px;
                margin-bottom: 3px;
            }

            #status {
                font-size: 12px;
            }

            .controls label {
                font-size: 12px;
            }

            select {
                font-size: 12px;
                padding: 8px 10px;
            }

            #chart-container {
                height: 300px;
                min-height: 250px;
            }

            .majority-badge {
                font-size: 12px;
                padding: 8px;
                margin-top: 5px;
            }
        }
    </style>
</head>
<body>

<div class="container-wrapper">
    <div class="header">
        
        <div id="status">Loading data from Google Sheets...</div>
    </div>

    <div class="controls">
        <label for="countrySelect"><b>Select Country:</b> </label>
        <select id="countrySelect" onchange="updateCountryParameter(); populateLegislatureTypeDropdown()">
            <option value="">-- Select --</option>
        </select>
        <label for="legislatureTypeSelect"><b>Select Legislature Type:</b> </label>
        <select id="legislatureTypeSelect" onchange="updateLegislatureTypeParameter(); renderSelection()">
            <option value="">-- Select --</option>
        </select>
    </div>

    <div id="chart-container"></div>
    <div id="majority-info" class="majority-badge"></div>
</div>

<script>
const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSyXtnBVLH8-6135tCS-f9EX3WBxfY8ZVe77zvJx4YIRDv3X7_9xZ68vWsUiWmkldfIL1jCRWkOxpfB/pub?gid=947087391&single=true&output=csv';

let electionData = [];
let chart;

// 1. Fetch data from Google Sheets
async function fetchData() {
    try {
        const response = await fetch(CSV_URL);
        const csvText = await response.text();
        parseCSV(csvText);
        document.getElementById('status').innerText = "Data Loaded Successfully";
        setTimeout(() => document.getElementById('status').style.display = 'none', 3000);
    } catch (error) {
        console.error("Error fetching CSV:", error);
        document.getElementById('status').innerText = "Error loading data. Please check the URL.";
        document.getElementById('status').style.color = "red";
    }
}

// 2. Simple CSV Parser
function parseCSV(text) {
    const lines = text.trim().split('\n');
    const headers = lines[0].split(',');
    
    // Find the index of the Color Hex column
    const colorHexIndex = headers.findIndex(h => h.trim().toLowerCase().includes('color'));
    
    // Convert CSV rows to JSON objects
    electionData = lines.slice(1).map(line => {
        // This handle cases where party names might contain commas inside quotes
        const values = line.match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g); 
        if (!values) return null;
        
        // Get color from the Color Hex column (fallback to values[7] if not found)
        let colorValue = '#808080'; // default gray
        if (colorHexIndex >= 0 && values[colorHexIndex]) {
            colorValue = values[colorHexIndex].replace(/"/g, '').trim();
        } else if (values[7]) {
            colorValue = values[7].replace(/"/g, '').trim();
        }
        
        return {
            country: values[0].replace(/"/g, ''),
            body: values[1].replace(/"/g, ''),
            totalSeats: parseInt(values[2]),
            year: values[3],
            party: values[4].replace(/"/g, ''),
            seats: parseInt(values[5]),
            colorHex: colorValue
        };
    }).filter(item => item !== null);

    populateDropdown();
}

// 3. Setup Dropdowns
function populateDropdown() {
    const countrySelect = document.getElementById('countrySelect');
    
    // Get unique countries
    const uniqueCountries = [...new Set(electionData.map(d => d.country))].sort();
    
    uniqueCountries.forEach(country => {
        let opt = document.createElement('option');
        opt.value = country;
        opt.innerHTML = country;
        countrySelect.appendChild(opt);
    });

    // Check URL parameters for country filter
    const urlParams = new URLSearchParams(window.location.search);
    const countryParam = urlParams.get('country');
    
    if (countryParam) {
        // Decode the parameter and try to match it
        const decodedCountry = decodeURIComponent(countryParam);
        if (uniqueCountries.includes(decodedCountry)) {
            countrySelect.value = decodedCountry;
            populateLegislatureTypeDropdown();
        } else {
            // If parameter doesn't match, select the first one
            if (uniqueCountries.length > 0) {
                countrySelect.value = uniqueCountries[0];
                populateLegislatureTypeDropdown();
            }
        }
    } else {
        // Auto-select the first one if no parameter
        if (uniqueCountries.length > 0) {
            countrySelect.value = uniqueCountries[0];
            populateLegislatureTypeDropdown();
        }
    }
}

// Populate legislature type dropdown based on selected country
function populateLegislatureTypeDropdown() {
    const legislatureTypeSelect = document.getElementById('legislatureTypeSelect');
    const countrySelect = document.getElementById('countrySelect');
    const selectedCountry = countrySelect.value;
    
    // Clear existing options except the first one
    legislatureTypeSelect.innerHTML = '<option value="">-- Select --</option>';
    
    if (!selectedCountry) return;
    
    // Get legislature types for the selected country
    const countryData = electionData.filter(d => d.country === selectedCountry);
    const uniqueTypes = [...new Set(countryData.map(d => d.body))].sort();
    
    uniqueTypes.forEach(type => {
        let opt = document.createElement('option');
        opt.value = type;
        opt.innerHTML = type;
        legislatureTypeSelect.appendChild(opt);
    });
    
    // Auto-select the first type
    if (uniqueTypes.length > 0) {
        legislatureTypeSelect.value = uniqueTypes[0];
        renderSelection();
    }
}

// Update URL when legislature type is changed
function updateLegislatureTypeParameter() {
    // URL is not updated when legislature type changes
}

// Update URL when country is changed
function updateCountryParameter() {
    const selectedCountry = document.getElementById('countrySelect').value;
    if (selectedCountry) {
        const url = new URL(window.location);
        url.searchParams.set('country', selectedCountry);
        window.history.replaceState({ path: url.href }, '', url.href);
    }
}

// 4. Render the Chart
function renderSelection() {
    const selectedType = document.getElementById('legislatureTypeSelect').value;
    const selectedCountry = document.getElementById('countrySelect').value;
    
    const filtered = electionData.filter(d => d.body === selectedType && d.country === selectedCountry);
    
    if (filtered.length === 0) return;

    const totalSeats = filtered[0].totalSeats;
    const majority = Math.floor(totalSeats / 2) + 1;
    
    // Create chart data with color information from each party
    const chartData = filtered.map(d => ({
        name: d.party,
        y: d.seats,
        color: d.colorHex
    }));

    document.getElementById('majority-info').innerHTML = `Total Seats: <b>${totalSeats}</b> | Majority Required: <b>${majority}</b>`;

    if (chart) chart.destroy();

    // Responsive sizing based on screen width
    const isMobile = window.innerWidth <= 768;
    const isSmallMobile = window.innerWidth <= 480;
    
    const chartSize = isSmallMobile ? '150%' : isMobile ? '160%' : '170%';
    const titleFontSize = isSmallMobile ? '16px' : isMobile ? '18px' : '24px';
    const labelFontSize = isSmallMobile ? '10px' : isMobile ? '12px' : '14px';

    chart = Highcharts.chart('chart-container', {
        chart: { 
            type: 'item',
            responsive: {
                rules: [{
                    condition: { maxWidth: 480 },
                    chartOptions: {
                        legend: { enabled: true, layout: 'vertical', align: 'center', verticalAlign: 'bottom', y: 0 }
                    }
                }]
            }
        },
        title: { 
            text: filtered[0].country + ' Election ' + filtered[0].year,
            style: { fontSize: titleFontSize, fontWeight: 'bold' }
        },
        subtitle: { 
            text: filtered[0].body,
            style: { fontSize: isSmallMobile ? '11px' : isMobile ? '12px' : '14px' }
        },
        xAxis: {
            plotLines: [{
                value: 0,
                color: '#444',
                dashStyle: 'LongDash',
                width: 2,
                zIndex: 5,
                label: { 
                    text: `Majority: ${majority}`, 
                    verticalAlign: 'top',
                    textAlign: 'center',
                    y: -10,
                    style: { fontWeight: 'bold', fontSize: labelFontSize }
                }
            }]
        },
        legend: {
            labelFormat: '{name} <span style="opacity: 0.6">({y})</span>',
            layout: 'horizontal',
            align: 'center',
            verticalAlign: 'top'
        },
        series: [{
            name: 'Seats',
            data: chartData,
            center: ['50%', '88%'],
            size: chartSize,
            startAngle: -100,
            endAngle: 100,
            dataLabels: { enabled: false }
        }],
        tooltip: {
            headerFormat: '',
            pointFormat: '<b>{point.name}</b>: {point.y} seats'
        },
        credits: { enabled: false }
    });
}

// Handle window resize to re-render chart responsively
window.addEventListener('resize', () => {
    const selectedKey = document.getElementById('electionSelect').value;
    if (selectedKey) renderSelection();
});

// Initialize on page load
fetchData();
</script>

</body>
</html>